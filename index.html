<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Separador de XML por Evento</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start p-6">
  <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-3xl mt-10">
    <h1 class="text-2xl font-bold text-gray-700 mb-6 text-center">ðŸ“‚ Separador de XML por Evento</h1>

    <!-- Upload -->
    <div class="mb-4">
      <label class="block text-gray-600 font-medium mb-2">Selecione um ou mais arquivos ZIP:</label>
      <input type="file" id="zipInput" multiple accept=".zip"
        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
    </div>

    <!-- Barra de progresso -->
    <div id="progressContainer" class="hidden mb-4">
      <div class="w-full bg-gray-200 rounded-full h-5">
        <div id="progressBar" class="bg-blue-600 h-5 rounded-full w-0"></div>
      </div>
      <div class="flex justify-between text-sm mt-1">
        <span id="progressPercent">0%</span>
        <span id="progressTime">Estimativa: --</span>
      </div>
    </div>

    <!-- Status / Total -->
    <div id="status" class="text-gray-700 mb-4"></div>

    <!-- Tipos detectados -->
    <div id="eventTypesSection" class="hidden">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-semibold text-gray-700">Tipos de eventos encontrados:</h2>
        <button id="selectAllBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">Selecionar todos</button>
      </div>
      <div id="eventTypesList" class="grid grid-cols-2 gap-3"></div>

      <button id="generateBtn" disabled
        class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow-md disabled:opacity-50">
        ðŸ“¦ Gerar ZIPs Separados
      </button>
    </div>
  </div>

  <script>
    const zipInput = document.getElementById("zipInput");
    const eventTypesSection = document.getElementById("eventTypesSection");
    const eventTypesList = document.getElementById("eventTypesList");
    const generateBtn = document.getElementById("generateBtn");
    const statusDiv = document.getElementById("status");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const progressPercent = document.getElementById("progressPercent");
    const progressTime = document.getElementById("progressTime");
    const selectAllBtn = document.getElementById("selectAllBtn");

    let filesByEvent = {};

    zipInput.addEventListener("change", async (e) => {
      filesByEvent = {};
      eventTypesList.innerHTML = "";
      eventTypesSection.classList.add("hidden");
      generateBtn.disabled = true;
      progressContainer.classList.remove("hidden");
      progressBar.style.width = '0%';
      progressPercent.textContent = '0%';
      progressTime.textContent = 'Estimativa: --';
      statusDiv.textContent = "ðŸ“‚ Lendo arquivos ZIP... Aguarde";

      const files = e.target.files;
      if (!files.length) {
        statusDiv.textContent = "Nenhum arquivo selecionado.";
        progressContainer.classList.add("hidden");
        return;
      }

      let totalXML = 0;
      let processedXML = 0;
      const startTime = Date.now();
      const zipObjects = [];

      // PrÃ©-carrega todos os ZIPs
      for (const file of files) {
        const data = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(data);
        zipObjects.push(zip);
      }

      // Conta total de XMLs para a barra de progresso
      let totalFiles = 0;
      zipObjects.forEach(zip => {
        totalFiles += Object.keys(zip.files).filter(f => f.endsWith(".xml")).length;
      });

      // Processa arquivos com barra de progresso
      for (const zip of zipObjects) {
        for (const fileName of Object.keys(zip.files)) {
          if (fileName.endsWith(".xml")) {
            const match = fileName.match(/S-\d{4}/);
            if (match) {
              const eventType = match[0].replace("-", "");
              if (!filesByEvent[eventType]) filesByEvent[eventType] = [];
              const blob = await zip.files[fileName].async("blob");
              filesByEvent[eventType].push({ name: fileName.split("/").pop(), blob });
              totalXML++;
            }
            // Atualiza barra de progresso
            processedXML++;
            const percent = Math.round((processedXML / totalFiles) * 100);
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';

            const elapsed = (Date.now() - startTime) / 1000; // em segundos
            const remaining = Math.round((elapsed / processedXML) * (totalFiles - processedXML));
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            progressTime.textContent = `Estimativa: ${minutes}m ${seconds}s`;
            await new Promise(r => setTimeout(r, 0)); // forÃ§a atualizaÃ§Ã£o visual
          }
        }
      }

      const eventTypes = Object.keys(filesByEvent);
      if (eventTypes.length === 0) {
        statusDiv.textContent = "Nenhum arquivo XML encontrado nos ZIPs selecionados.";
        progressContainer.classList.add("hidden");
        return;
      }

      // Mostra status com total
      statusDiv.textContent = `âœ… Total de arquivos XML: ${totalXML} em ${eventTypes.length} tipos de evento. Marque os desejados abaixo.`;
      progressContainer.classList.add("hidden");

      // Mostra checkboxes
      eventTypesSection.classList.remove("hidden");
      Object.keys(filesByEvent).sort().forEach(type => {
        const div = document.createElement("div");
        div.className = "flex items-center space-x-2 bg-gray-50 p-3 rounded-lg shadow-sm";
        div.innerHTML = `
          <input type="checkbox" id="chk-${type}" value="${type}" class="w-4 h-4 text-blue-600 rounded">
          <label for="chk-${type}" class="text-gray-700 font-medium">${type} (${filesByEvent[type].length} arquivos)</label>
        `;
        eventTypesList.appendChild(div);
      });
    });

    // Habilita botÃ£o quando marcar algo
    eventTypesList.addEventListener("change", () => {
      const anyChecked = eventTypesList.querySelectorAll("input:checked").length > 0;
      generateBtn.disabled = !anyChecked;
    });

    // BotÃ£o Selecionar todos
    selectAllBtn.addEventListener("click", () => {
      eventTypesList.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = true);
      generateBtn.disabled = false;
    });

    // Gera os ZIPs mantendo nomes originais
    generateBtn.addEventListener("click", async () => {
      const selected = [...eventTypesList.querySelectorAll("input:checked")].map(c => c.value);

      for (const type of selected) {
        const zip = new JSZip();
        filesByEvent[type].forEach(fileObj => {
          zip.file(fileObj.name, fileObj.blob);
        });
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, `${type}.zip`);
      }

      statusDiv.textContent = `âœ… Download concluÃ­do para: ${selected.join(", ")}`;
    });
  </script>
</body>
</html>
