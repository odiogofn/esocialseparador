<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de ZIPs S-XX</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 20px; }
h2 { text-align: center; margin-bottom: 15px; }
#dropArea { border: 2px dashed #4caf50; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; color: #555; transition: 0.3s; margin-bottom: 15px; }
#dropArea.hover { background: #e8f5e9; border-color: #45a049; }
button { padding: 6px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; background: #4caf50; color: white; transition: 0.2s; }
button:hover { background: #45a049; }
.progress-bar { width: 100%; background: #eee; border-radius: 8px; overflow: hidden; height: 18px; margin-bottom: 10px; }
.progress { height: 18px; width: 0%; background: #4caf50; transition: width 0.2s; }
.zip-container { background: #fff; padding: 15px; margin: 5px; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); flex: 1 1 200px; display: flex; justify-content: space-between; align-items: center; }
.zip-container button { margin: 0; }
.zip-list { display: flex; flex-wrap: wrap; margin-top: 10px; }
.status { font-size: 0.95em; color: #333; margin: 3px 0; }
.error { color: red; font-weight: bold; margin-top: 10px; }
</style>
</head>
<body>
<h2>Leitor de ZIPs S-XX</h2>

<div id="dropArea">Clique ou arraste arquivos ZIP aqui</div>
<input type="file" id="zipInput" multiple accept=".zip" style="display:none;">

<div class="progress-bar"><div class="progress" id="overallProgressBar"></div></div>
<div id="statusArea" class="status"></div>
<div id="fileList" class="zip-list"></div>
<div id="errors" class="error"></div>

<div class="controls">
    <button id="downloadAll">Download todos selecionados</button>
</div>

<script>
let zipGroups = {};
let zipSelection = {};
let arquivosCorrompidos = [];

const dropArea = document.getElementById('dropArea');
const zipInput = document.getElementById('zipInput');
const overallProgressBar = document.getElementById('overallProgressBar');
const statusArea = document.getElementById('statusArea');
const fileList = document.getElementById('fileList');
const errorsDiv = document.getElementById('errors');

dropArea.addEventListener('click', ()=>zipInput.click());
dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.classList.add('hover'); });
dropArea.addEventListener('dragleave', e=>{ dropArea.classList.remove('hover'); });
dropArea.addEventListener('drop', e=>{ e.preventDefault(); dropArea.classList.remove('hover'); handleFiles(e.dataTransfer.files); });

zipInput.addEventListener('change', e=>handleFiles(e.target.files));

async function handleFiles(files){
    zipGroups = {};
    zipSelection = {};
    arquivosCorrompidos = [];
    fileList.innerHTML = '';
    statusArea.innerHTML = '';
    errorsDiv.innerHTML = '';
    overallProgressBar.style.width = '0%';

    let totalFiles = 0;
    for(const file of files){
        try{
            const zip = new JSZip();
            const content = await file.arrayBuffer();
            const zipContent = await zip.loadAsync(content);
            totalFiles += Object.keys(zipContent.files).length;
        } catch(e){ totalFiles += 1; }
    }

    let processedFiles = 0;
    const startTime = Date.now();

    for(const file of files){
        try{
            const zip = new JSZip();
            const content = await file.arrayBuffer();
            const zipContent = await zip.loadAsync(content);

            for(const [fullPath, zipEntry] of Object.entries(zipContent.files)){
                if(!zipEntry.dir){
                    const fileName = zipEntry.name.split("/").pop();
                    try{
                        const blob = await zipEntry.async("blob");
                        const match = fileName.match(/S-?\d+/i);
                        if(match){
                            const tipo = match[0].toUpperCase();
                            if(!zipGroups[tipo]) zipGroups[tipo] = new JSZip();
                            zipGroups[tipo].file(fileName, blob);
                        }
                    } catch(errFile){
                        arquivosCorrompidos.push(fileName);
                    }
                }
                processedFiles++;
                const percent = ((processedFiles/totalFiles)*100).toFixed(0);
                const elapsed = (Date.now()-startTime)/1000;
                const estTime = ((elapsed/processedFiles)*(totalFiles-processedFiles)).toFixed(1);
                overallProgressBar.style.width = percent + "%";
                statusArea.textContent = `Progresso: ${percent}% | Tempo restante estimado: ${estTime}s`;
            }

        } catch(err){
            arquivosCorrompidos.push(file.name);
            processedFiles++;
            const percent = ((processedFiles/totalFiles)*100).toFixed(0);
            const elapsed = (Date.now()-startTime)/1000;
            const estTime = ((elapsed/processedFiles)*(totalFiles-processedFiles)).toFixed(1);
            overallProgressBar.style.width = percent + "%";
            statusArea.textContent = `Progresso: ${percent}% | Tempo restante estimado: ${estTime}s`;
        }
    }

    statusArea.textContent = "Leitura concluída ✅";

    fileList.innerHTML = "";
    Object.keys(zipGroups).forEach(tipo=>{
        zipSelection[tipo] = true;
        const zipObj = zipGroups[tipo];
        const fileCount = Object.keys(zipObj.files).length;

        const container = document.createElement("div");
        container.className = "zip-container";
        container.innerHTML = `
            <label><input type="checkbox" id="chk-${tipo}" checked> <strong>${tipo}.zip</strong> (${fileCount} arquivos)</label>
            <button id="download-${tipo}">Download</button>
        `;
        fileList.appendChild(container);

        document.getElementById(`chk-${tipo}`).addEventListener("change", e=>{
            zipSelection[tipo] = e.target.checked;
        });

        document.getElementById(`download-${tipo}`).addEventListener("click", async ()=>{
            const blob = await zipObj.generateAsync({type:"blob"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${tipo}.zip`;
            a.click();
        });
    });

    if(arquivosCorrompidos.length>0){
        errorsDiv.innerHTML = "<strong>Não foi possível ler os seguintes arquivos:</strong><br>" + arquivosCorrompidos.join("<br>");
    }
}

document.getElementById("downloadAll").addEventListener("click", async ()=>{
    const selectedTypes = Object.keys(zipSelection).filter(tipo=>zipSelection[tipo]);
    if(selectedTypes.length === 0){ alert("Nenhum ZIP selecionado."); return; }
    for(const tipo of selectedTypes){
        const zipObj = zipGroups[tipo];
        const blob = await zipObj.generateAsync({type:"blob"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${tipo}.zip`;
        a.click();
    }
});
</script>
</body>
</html>
